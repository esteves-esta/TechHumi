<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <link rel="stylesheet" href="estilos/estilo.css">

    <link rel="shotcut icon" href="imgs/favicon.png">

    <meta name="description" content="Projeto acadêmico de aplicação utilizando IOT">

    <script src="../Usuarios/theme/js/sweetalert.min.js"></script>

    <title>Login</title>
</head>

<body>
    <nav class="imagem">
        <img src="imgs/logo.png">
    </nav>

    <article>
        <section class="formulario">


            <form id="form_login" method="post" onsubmit="return senhaesqueceu()">
                <label>Email</label>
                <input type="email" id="email" name="email" placeholder="Email cadastrado" required>

                <div>
                    <button type="button" class="botao" onclick="valida()">Redefinir Senha</button>
                    <a class="botao" href="login.html">Fazer login</a>
                </div>
            </form>

        </section>

        <section class="welcome">
            <div>
                <h1>Bem vindo à TechHumi</h1>
                <h3>Faça o login para acessar sua conta.</h3>
            </div>
        </section>

    </article>


    <!-- SCRIPTS DO PROJETO -->

    <!-- script do suporte -->
    <script type="text/javascript" src="../Usuarios/theme/js/suporte.js"></script>
</body>

</html>
<script>

    email.focus();

    function valida() {
        if (email.value == '') {
            swal({
                icon: "error",
                title: `Por Favor, Insira Seu Email!`
            });
        }

        else {
            senhaesqueceu()
        }
    }

    function senhaesqueceu() {
        var formulario = new URLSearchParams(new FormData(redefinir));
        fetch("/email/enviar_email", {
            method: "POST",
            body: formulario
        }).then(function (response) {

            if (response.ok) {
                swal({
                    title: `Enviamos um Email de Redefinição de Senha para esse Endereço`
                }); 
                
                consultarEmail();
            } else {
                swal({
                    icon: "error",
                    title: `Por Favor, Insira Seu Email!`
                });

            }
        });

        return false;
    }

    function consultarEmail() {
        var formulario = new URLSearchParams(new FormData(redefinir));
        fetch("/consulta-perfil/consulta-email", {
            method: "POST",
            body: formulario
        }).then(function (response) {

            if (response.ok) {
                response.json().then(function (resposta) {
                    alterar_dados(resposta[0].idLogin);
                });
            } else {
                    consultarEmail();
            }
        });
        return false;
    }

    //Alterar senha
    function alterar_dados(codigo) {

        var info = {
            senha: "1234",
            confirmaSenha: "1234",
            estrangeira: codigo
        }

        var formulario = new URLSearchParams(info);
        fetch("/alterar/alterar-senha", {
            method: "POST",
            body: formulario
        }).then(function (response) {

            if (response.ok) {

                swal({
                    title: "Alterado com sucesso!",
                    text: "   ",
                    icon: "success"
                });


            } else {

               alterar_dados();
            }
        });

        return false;
    }


</script>